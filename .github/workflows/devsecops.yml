name: DevSecOps Pipeline

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

env:
  AWS_REGION: eu-west-3
  ECR_REPOSITORY: social-media-api
  ECS_CLUSTER_STAGING: social-media-api-staging
  ECS_SERVICE_STAGING: social-media-api-staging-service
  ECS_CLUSTER_PROD: social-media-api-production
  ECS_SERVICE_PROD: social-media-api-prod-service

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: Build with Maven
        run: |
          mvn clean package -DskipTests
          echo "Build completed at $(date)"
      
      - name: Run Unit Tests
        run: |
          mvn test
          echo "Tests completed: $(find target/surefire-reports -name '*.xml' | wc -l) test files"
      
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: target/*.jar
          retention-days: 30
      
      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-reports
          path: target/surefire-reports/
          retention-days: 30

  sast-semgrep:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Semgrep SAST
        run: |
          pip3 install semgrep
          semgrep --config=auto --json --output=semgrep-report.json . || true
          semgrep --config=auto --sarif --output=semgrep-report.sarif . || true
      
      - name: Validate SAST report
        run: |
          if [ ! -s semgrep-report.json ]; then
            echo "WARNING: SAST report is empty, creating minimal report"
            echo '{"results":[],"errors":[]}' > semgrep-report.json
          else
            echo "SAST report size: $(stat -c%s semgrep-report.json) bytes"
            FINDINGS=$(jq '.results | length' semgrep-report.json)
            echo "Total findings: $FINDINGS"
          fi
      
      - name: Upload SAST reports
        uses: actions/upload-artifact@v4
        with:
          name: sast-reports
          path: |
            semgrep-report.json
            semgrep-report.sarif
          retention-days: 30
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Upload SAST reports to S3
        run: |
          aws s3 cp semgrep-report.json s3://social-media-api-reports-${{ secrets.AWS_ACCOUNT_ID }}/sast-reports/${{ github.run_number }}/ --region eu-west-3
          aws s3 cp semgrep-report.sarif s3://social-media-api-reports-${{ secrets.AWS_ACCOUNT_ID }}/sast-reports/${{ github.run_number }}/ --region eu-west-3

  dependency-scan:
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: application-jar
          path: target/
      
      - name: Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
          grype version
      
      - name: Run Grype CVE Scan on JAR
        run: |
          echo "Scanning JAR files for vulnerabilities..."
          grype target/*.jar --output json --file grype-report.json
          grype target/*.jar --output table > grype-report.txt
      
      - name: Validate and summarize CVE report
        run: |
          if [ ! -s grype-report.json ]; then
            echo "ERROR: Grype report is empty!"
            exit 1
          fi
          
          echo "Grype report size: $(stat -c%s grype-report.json) bytes"
          
          CRITICAL=$(grep -o '"severity":"Critical"' grype-report.json | wc -l || echo "0")
          HIGH=$(grep -o '"severity":"High"' grype-report.json | wc -l || echo "0")
          MEDIUM=$(grep -o '"severity":"Medium"' grype-report.json | wc -l || echo "0")
          LOW=$(grep -o '"severity":"Low"' grype-report.json | wc -l || echo "0")
          
          echo "CVE Summary:"
          echo "  Critical: $CRITICAL"
          echo "  High: $HIGH"
          echo "  Medium: $MEDIUM"
          echo "  Low: $LOW"
          
          SCAN_DATE=$(date -Iseconds)
          TOTAL=$(($CRITICAL + $HIGH + $MEDIUM + $LOW))
          
          jq -n \
            --arg scan_date "$SCAN_DATE" \
            --argjson critical "$CRITICAL" \
            --argjson high "$HIGH" \
            --argjson medium "$MEDIUM" \
            --argjson low "$LOW" \
            --argjson total "$TOTAL" \
            '{scan_date: $scan_date, critical: $critical, high: $high, medium: $medium, low: $low, total: $total}' \
            > grype-summary.json
          
          if [ "$CRITICAL" -gt 0 ]; then
            echo "WARNING: Found $CRITICAL critical vulnerabilities (not blocking build)"
          fi
      
      - name: Upload CVE reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cve-reports
          path: |
            grype-report.json
            grype-report.txt
            grype-summary.json
          retention-days: 30
      
      - name: Configure AWS credentials
        if: always()
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Upload CVE reports to S3
        if: always()
        run: |
          aws s3 cp grype-report.json s3://social-media-api-reports-${{ secrets.AWS_ACCOUNT_ID }}/cve-reports/${{ github.run_number }}/ --region eu-west-3
          aws s3 cp grype-report.txt s3://social-media-api-reports-${{ secrets.AWS_ACCOUNT_ID }}/cve-reports/${{ github.run_number }}/ --region eu-west-3
          aws s3 cp grype-summary.json s3://social-media-api-reports-${{ secrets.AWS_ACCOUNT_ID }}/cve-reports/${{ github.run_number }}/ --region eu-west-3

  build-docker:
    runs-on: ubuntu-latest
    needs: [build-and-test, sast-semgrep, dependency-scan]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: application-jar
          path: target/
      
      - name: Build Docker image
        run: |
          docker build -t ${{ env.ECR_REPOSITORY }}:${{ github.sha }} .
          docker tag ${{ env.ECR_REPOSITORY }}:${{ github.sha }} ${{ env.ECR_REPOSITORY }}:latest
      
      - name: Save Docker image
        run: docker save ${{ env.ECR_REPOSITORY }}:${{ github.sha }} | gzip > docker-image.tar.gz
      
      - name: Upload Docker image
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: docker-image.tar.gz
          retention-days: 7

  container-scan:
    runs-on: ubuntu-latest
    needs: build-docker
    
    steps:
      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
      
      - name: Load Docker image
        run: docker load < docker-image.tar.gz
      
      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy
      
      - name: Run Trivy container scan
        run: |
          trivy image --format json --output trivy-report.json ${{ env.ECR_REPOSITORY }}:${{ github.sha }}
          trivy image --format sarif --output trivy-report.sarif ${{ env.ECR_REPOSITORY }}:${{ github.sha }}
          trivy image ${{ env.ECR_REPOSITORY }}:${{ github.sha }}
      
      - name: Validate container scan report
        run: |
          if [ ! -s trivy-report.json ]; then
            echo "ERROR: Trivy report is empty!"
            exit 1
          fi
          
          echo "Trivy report size: $(stat -c%s trivy-report.json) bytes"
          
          CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-report.json)
          HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-report.json)
          
          echo "Container Vulnerabilities:"
          echo "  Critical: $CRITICAL"
          echo "  High: $HIGH"
      
      - name: Upload container scan reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: container-scan-reports
          path: |
            trivy-report.json
            trivy-report.sarif
          retention-days: 30
      
      - name: Configure AWS credentials
        if: always()
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Upload container scan reports to S3
        if: always()
        run: |
          aws s3 cp trivy-report.json s3://social-media-api-reports-${{ secrets.AWS_ACCOUNT_ID }}/container-scan-reports/${{ github.run_number }}/ --region eu-west-3
          aws s3 cp trivy-report.sarif s3://social-media-api-reports-${{ secrets.AWS_ACCOUNT_ID }}/container-scan-reports/${{ github.run_number }}/ --region eu-west-3

  iac-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Checkov
        run: pip3 install checkov
      
      - name: Run Checkov IaC scan
        run: |
          mkdir -p reports
          checkov -d terraform/ \
            --framework terraform \
            --output json \
            --output-file-path reports \
            --soft-fail || true
          
          if [ -f reports/results_json.json ]; then
            mv reports/results_json.json reports/checkov-report.json
          else
            echo "WARNING: Checkov didn't create output, creating empty report"
            echo '{"summary":{"passed":0,"failed":0},"results":{"passed_checks":[],"failed_checks":[]}}' > reports/checkov-report.json
          fi
      
      - name: Validate and summarize IaC scan
        run: |
          if [ ! -s reports/checkov-report.json ]; then
            echo "WARNING: Checkov report is empty"
          else
            echo "Checkov report size: $(stat -c%s reports/checkov-report.json) bytes"
            
            PASSED=$(jq '.summary.passed // 0' reports/checkov-report.json)
            FAILED=$(jq '.summary.failed // 0' reports/checkov-report.json)
            
            echo "IaC Security Summary:"
            echo "  Passed checks: $PASSED"
            echo "  Failed checks: $FAILED"
            
            STATUS="PASSED"
            if [ "$FAILED" -gt 5 ]; then
              STATUS="CRITICAL"
            fi
            
            SCAN_DATE=$(date -Iseconds)
            
            jq -n \
              --arg scan_date "$SCAN_DATE" \
              --argjson passed "$PASSED" \
              --argjson failed "$FAILED" \
              --arg status "$STATUS" \
              '{scan_date: $scan_date, passed: $passed, failed: $failed, status: $status}' \
              > reports/checkov-summary.json
          fi
      
      - name: Upload IaC scan reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: iac-scan-reports
          path: reports/
          retention-days: 30
      
      - name: Configure AWS credentials
        if: always()
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Upload IaC scan reports to S3
        if: always()
        run: |
          aws s3 cp reports/ s3://social-media-api-reports-${{ secrets.AWS_ACCOUNT_ID }}/iac-scan-reports/${{ github.run_number }}/ --recursive --region eu-west-3

  deploy-staging:
    runs-on: ubuntu-latest
    needs: [build-docker, container-scan, iac-scan]
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
      
      - name: Load and push to ECR
        run: |
          docker load < docker-image.tar.gz
          
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
            docker login --username AWS --password-stdin \
            ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com
          
          docker tag ${{ env.ECR_REPOSITORY }}:${{ github.sha }} \
            ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
          
          docker tag ${{ env.ECR_REPOSITORY }}:${{ github.sha }} \
            ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:latest
          
          docker push ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
          docker push ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:latest
      
      - name: Deploy to ECS Staging
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER_STAGING }} \
            --service ${{ env.ECS_SERVICE_STAGING }} \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}
          
          echo "Waiting for staging deployment to stabilize..."
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER_STAGING }} \
            --services ${{ env.ECS_SERVICE_STAGING }} \
            --region ${{ env.AWS_REGION }}

  dast-scan:
    runs-on: ubuntu-latest
    needs: deploy-staging
    permissions:
      contents: read
      issues: write
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Discover staging endpoint
        run: |
          STAGING_IP=$(aws ec2 describe-instances \
          --filters "Name=tag:Name,Values=social-media-api-staging-ecs" \
                    "Name=instance-state-name,Values=running" \
          --query 'Reservations[0].Instances[0].PublicIpAddress' \
          --output text \
          --region eu-west-3)

          echo "STAGING_URL=http://${STAGING_IP}:8080" >> $GITHUB_ENV
          echo "Staging URL: http://${STAGING_IP}:8080"
      
      - name: Wait for application health
        run: |
          echo "Waiting for application to be healthy..."
          for i in {1..30}; do
            if curl -sf ${STAGING_URL}/actuator/health; then
              echo "✓ Application is healthy!"
              exit 0
            fi
            echo "Attempt $i/30: Application not ready, waiting..."
            sleep 10
          done
          echo "ERROR: Application failed to become healthy"
          exit 1
      - name: Fix permissions for ZAP
        run: chmod -R 777 ${{ github.workspace }}
      - name: Run OWASP ZAP baseline scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: ${{ env.STAGING_URL }}
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j'
          artifact_name: 'zap-reports'
          fail_action: false
      
      - name: Download ZAP reports
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: zap-reports
          path: zap-reports/
      
      - name: Validate DAST report
        if: always()
        run: |
          if [ -f zap-reports/report_json.json ]; then
            echo "ZAP report size: $(stat -c%s zap-reports/report_json.json) bytes"
            ALERTS=$(jq '.site[0].alerts | length' zap-reports/report_json.json || echo "0")
            echo "Total alerts found: $ALERTS"
          else
            echo "WARNING: ZAP report not found"
          fi
      
      - name: Upload DAST reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dast-scan-reports
          path: zap-reports/
          retention-days: 30
      
      - name: Upload DAST reports to S3
        if: always()
        run: |
          aws s3 cp zap-reports/ s3://social-media-api-reports-${{ secrets.AWS_ACCOUNT_ID }}/dast-reports/${{ github.run_number }}/ --recursive --region eu-west-3

  deploy-production:
    runs-on: ubuntu-latest
    needs: dast-scan
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Deploy to ECS Production
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER_PROD }} \
            --service ${{ env.ECS_SERVICE_PROD }} \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}
          
          echo "Waiting for production deployment to stabilize..."
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER_PROD }} \
            --services ${{ env.ECS_SERVICE_PROD }} \
            --region ${{ env.AWS_REGION }}
      
      - name: Get production endpoint
        run: |
          PROD_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=social-media-api-production-ecs" \
                      "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text \
            --region ${{ env.AWS_REGION }})
          
          echo "Production endpoint: http://${PROD_IP}:8080"
      
      - name: Verify production health
        run: |
          PROD_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=social-media-api-production-ecs" \
                      "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text \
            --region ${{ env.AWS_REGION }})
          
          for i in {1..10}; do
            if curl -sf http://${PROD_IP}:8080/actuator/health; then
              echo "✓ Production deployment successful!"
              exit 0
            fi
            sleep 5
          done
          echo "WARNING: Production health check failed"

  report-summary:
    runs-on: ubuntu-latest
    needs: [sast-semgrep, dependency-scan, container-scan, iac-scan, dast-scan]
    if: always()
    
    steps:
      - name: Download all reports
        uses: actions/download-artifact@v4
        with:
          path: all-reports/
      
      - name: Generate summary report
        run: |
          echo "# Security Scan Summary" > summary.md
          echo "" >> summary.md
          echo "**Build:** ${{ github.sha }}" >> summary.md
          echo "**Date:** $(date)" >> summary.md
          echo "" >> summary.md
          
          if [ -f all-reports/sast-reports/semgrep-report.json ]; then
            SAST_FINDINGS=$(jq '.results | length' all-reports/sast-reports/semgrep-report.json)
            echo "## SAST (Semgrep): $SAST_FINDINGS findings" >> summary.md
          fi
          
          if [ -f all-reports/cve-reports/grype-summary.json ]; then
            echo "## Dependency CVE Scan:" >> summary.md
            jq -r '"- Critical: \(.critical)\n- High: \(.high)\n- Medium: \(.medium)"' all-reports/cve-reports/grype-summary.json >> summary.md
          fi
          
          if [ -f all-reports/container-scan-reports/trivy-report.json ]; then
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' all-reports/container-scan-reports/trivy-report.json)
            echo "## Container Scan: $CRITICAL critical vulnerabilities" >> summary.md
          fi
          
          if [ -f all-reports/iac-scan-reports/checkov-summary.json ]; then
            echo "## IaC Security:" >> summary.md
            jq -r '"- Passed: \(.passed)\n- Failed: \(.failed)"' all-reports/iac-scan-reports/checkov-summary.json >> summary.md
          fi
          
          cat summary.md
      
      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: summary.md
          retention-days: 90